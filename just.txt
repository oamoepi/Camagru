<?php
session_start();
    $_SESSION['username'] ="Admin,";
?>

<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width">
        <meta name="description" content="Most Amazing Way For a Social">
        <meta name="keywords" content="Camagru, Social media, camagru42">
        <title>Gallery</title>
        <link rel="stylesheet" href="css/main.css">
    </head>
    <body>
        <header>
            <div class="container">
                <div id="branding">
                    <h1><span class="highlight">Welcome</span> Camagru</h1>
                </div>
                <nav>
                    <ul>
                        <li><a href="home.php">Home</a></li>
                        <li><a href="profile.php">Profile</a></li>
                        <li class="current"><a href="gallery.php">Gallery</a></li>
                        <a href="php/signout.php"><button class="button_1" type="button">Signout</button></a>            
                    </ul>
                </nav>  
                </div>
        </header>

        <section id="newsletter">
                <div class="container">
                    <h1>Organize Your Gallery</h1>
                </div>
        </section>

         <main>

         
            <section class="gallery-links">
                <div class="wrapper">
                    <h2>Gallery</h2>

                    <div class="gallery-container">
                    <?php
                     include ("includes/gallery-upload.inc.php");
                     include_once 'config/config.php';


                     if(isset($_POST['submit'])){

                        // Count total files
                        $countfiles = count($_FILES['files']['name']);
                       
                        // Prepared statement
                        $query = "INSERT INTO gallery (titleGallery, descGallery, imgFullNameGallery, orderGallery) VALUES(?,?,?,?)";
                      
                        $statement = $conn->prepare($query);
                      
                        // Loop all files
                        for($i=0;$i<$countfiles;$i++){
                      
                          // File name
                          $filename = $_FILES['files']['titleGallery'][$i];
                      
                          // Get extension
                          $ext = end((explode(".", $filename)));
                      
                          // Valid image extension
                          $valid_ext = array("png","jpeg","jpg");
                      
                          if(in_array($ext, $valid_ext)){
                      
                            // Upload file
                            if(move_uploaded_file($_FILES['files']['tmp_name'][$i],'upload/'.$filename)){
                      
                              // Execute query
                              $statement->execute(array($filename,'upload/'.$filename));
                      
                            }
                      
                          }
                       
                        }
                        echo "File upload successfully";
                      }
                    // $sql = "SELECT * FROM gallery ORDER BY orderGallery DESC";
                    // $stmt = mysqli_stmt_init($conn);
                    // if (!mysqli_stmt_prepare($stmt, $sql)) {
                    //     echo "SQL statement failed!";
                    // }else {
                    //     mysqli_stmt_execute($stmt);
                    //     $result =mysqli_stmt_get_result($stmt);

                    //     while ($row = mysqli_fetch_assoc($result)) {
                    //         echo '<a href="#">
                    //         <div style="background-image: url(img/gallery/'.$row["imgFullNameGallery"].');"></div>
                    //         <h3>'.$row["titleGallery"].'</h3>
                    //         <p>'.$row["descGallery"].'</p>
                    //         </a>';
                    //     }
                    // }
                    ?>
                    </div>


<?php
    if (isset($_SESSION['username'])){
                    echo '<div class="gallery-upload">
                        <form action="includes/gallery-upload.inc.php" method="post" enctype="multipart/form-data">
                            <input type="text" name="filename" placeholder="File name...">
                            <input type="text" name="filetitle" placeholder="Image title...">
                            <input type="text" name="filedesc" placeholder="Image description...">
                            <input type="file" name="file">
                            <button type="submit" name="submit">Upload</button>
                        </form>
                        </div>';
    }

?>
            </section>













        
 
        <footer>
            <p>amoepi@student.wethinkcode.co.za Copyright &copy; 2019</p>
        </footer>

    </body>
</html>


























if(isset($_POST['submit'])){

    // Count total files
    $countfiles = count($_FILES['files']['name']);
   
    // Prepared statement
    $query = "INSERT INTO images (name,image) VALUES(?,?)";
  
    $statement = $conn->prepare($query);
  
    // Loop all files
    for($i=0;$i<$countfiles;$i++){
  
      // File name
      $filename = $_FILES['files']['name'][$i];
  
      // Get extension
      $ext = end((explode(".", $filename)));

       // Select file type
       $imageFileType = strtolower(pathinfo($target_file,PATHINFO_EXTENSION));
  
      // Valid image extension
      $valid_ext = array("png","jpeg","jpg");
  
      if(in_array($ext, $valid_ext)){
  
        // Upload file
        if(move_uploaded_file($_FILES['files']['tmp_name'][$i],'upload/'.$filename)){
  
          // Execute query
          $statement->execute(array($filename,'upload/'.$filename));
  
        }
  
      }
   
    }
    echo "File upload successfully";
  }
try {
    $select = "INSERT * INTO images where id=0";
    $result = $conn->prepare($select);
    $result->execute();
    $row = $result->fetch();
    $image = $row['name'];
    $image_src = "upload/".$image;
} catch (PDOException $exception) {
    echo $update_uname."<br>".$exception->getMessage();
}

?>
<img src='<?php echo $image_src;  ?>' >

<form method="post" action="" enctype='multipart/form-data'>
  <input type='file' name='file' />
  <input type='submit' value='Save name' name='but_upload'>
</form>
